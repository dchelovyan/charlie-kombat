<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Rabbit Clicker ‚Äî Happy</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1730; --card:#111d3b; --muted:#9fb0d0; --accent:#1fa37c; --accent2:#2b6cb0;
    --tab:#0f1730; --tabActive:#1b2a56;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:480px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}

  .header{display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-radius:16px;padding:12px 14px}
  .balance{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .coin-img{width:22px;height:22px;object-fit:contain;vertical-align:middle}
  .sub{font-size:12px;color:var(--muted)}

  .tap{background:linear-gradient(180deg,#12254f,#0f1834);border-radius:16px;padding:16px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .tap-btn{
    width:100%; aspect-ratio:1/1; border-radius:50%; overflow:hidden; border:0;
    background:radial-gradient(100% 100% at 50% 35%,#1a2b5f 0%,#14224a 60%,#0f1834 100%);
    display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    box-shadow:inset 0 6px 18px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.4);
  }
  .tap-btn:active{transform:scale(.98)}
  .tap-btn img{width:88%; height:88%; object-fit:contain; display:block; pointer-events:none}
  .tap-info{margin-top:10px;display:flex;justify-content:space-between;color:var(--muted);font-size:13px}

  /* Tabs */
  .tabs{display:flex;gap:8px;background:transparent}
  .tab{
    flex:1; text-align:center; padding:10px 12px; border-radius:12px; cursor:pointer; user-select:none;
    background:var(--tab); color:#cfd9ff; font-weight:700; border:1px solid #1f2b56;
  }
  .tab.active{background:var(--tabActive); color:#fff; border-color:#2a3a6d; box-shadow:0 4px 16px rgba(0,0,0,.25) inset}
  .views{margin-top:6px}
  .view{display:none}
  .view.active{display:block}

  /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ –ï–¥—ã */
  .section{margin-top:10px}
  .section h3{margin:6px 0 8px; font-size:15px; opacity:.9}

  /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ï–¥—ã (–∞–ø–≥—Ä–µ–π–¥—ã) */
  .store{display:flex;flex-direction:column;gap:10px}
  .card{background:var(--card);border-radius:14px;padding:12px;display:flex;gap:12px;align-items:center}
  .icon-wrap{width:42px;height:42px;border-radius:10px;overflow:hidden;flex:0 0 42px;background:#0f1730;display:flex;align-items:center;justify-content:center}
  .icon-wrap img{width:100%;height:100%;object-fit:contain}
  .c-main{flex:1;min-width:0}
  .c-title{font-weight:700;display:flex;align-items:center;gap:8px}
  .lvl{font-size:11px;color:var(--muted);background:#152147;border-radius:999px;padding:2px 8px}
  .c-sub{font-size:12px;color:var(--muted);margin-top:2px}
  .row{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .mini{font-size:12px;color:var(--muted)}
  .buy{background:var(--accent);border:none;color:#04151f;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;min-width:124px}
  .buy.blue{background:var(--accent2);color:#e8f1ff}
  .buy:disabled{opacity:.5;cursor:not-allowed}

  /* –ö–∞—Ä—Ç–æ—á–∫–∏ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ) */
  .cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:6px}
  .kcard{background:var(--card);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .kcard .pic{width:100%;aspect-ratio:1/1;background:#0f1730;display:flex;align-items:center;justify-content:center}
  .kcard .pic img{width:100%;height:100%;object-fit:cover}
  .kcard .body{padding:10px;display:flex;flex-direction:column;gap:6px}
  .kcard .title{font-weight:700;font-size:14px}
  .kcard .desc{font-size:12px;color:var(--muted);line-height:1.25}
  .kcard .row{margin-top:2px}
  .kcard .buy{width:100%}
  .kcard .bought{opacity:.7;pointer-events:none}

  .footer{margin-top:10px;text-align:center;color:var(--muted);font-size:12px}
  .pill{display:inline-block;background:#152147;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:11px;color:var(--muted)}
  .reset{background:transparent;border:1px solid #2a3a6d;color:#8fa3d9;border-radius:10px;padding:8px 10px;cursor:pointer}
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="balance">
        <img id="coinIcon" class="coin-img" src="assets/ui/coin.png" alt="Happy">
        <span id="balance">0</span> <span class="pill">Happy</span>
      </div>
      <div class="sub">–≤ —Å–µ–∫: <span id="hps">0</span> ‚Ä¢ –∑–∞ —Ç–∞–ø: <span id="perTap">0</span> ‚Ä¢ –±–∞—Ñ –≤–æ–¥—ã: <span id="waterBuff">0</span>%</div>
    </div>
    <button id="reset" class="reset" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">–°–±—Ä–æ—Å</button>
  </div>

  <div class="tap">
    <button id="tapBtn" class="tap-btn" aria-label="Tap to get Happy">
      <img id="rabbitImg" src="assets/ui/rabbit_main.png" alt="Rabbit"/>
    </button>
    <div class="tap-info">
      <div>–¢–∞–ø–∞–π –ø–æ –∫—Ä–æ–ª–∏–∫—É, —á—Ç–æ–±—ã —Ñ–∞—Ä–º–∏—Ç—å Happy</div>
      <div>üôÇ –ø—Ä–∏—è—Ç–Ω–æ!</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div id="tabFood" class="tab active">–ï–¥–∞</div>
    <div id="tabCards" class="tab">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
  </div>

  <div class="views">
    <!-- View: –ï–¥–∞ -->
    <div id="viewFood" class="view active">
      <div id="foodRoot"></div>
    </div>

    <!-- View: –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div id="viewCards" class="view">
      <div id="cardsRoot" class="cards-grid"></div>
    </div>
  </div>

  <div class="footer">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Telegram Mini App</div>
</div>

<script>
/* ===== Telegram UX ===== */
const tg = window.Telegram?.WebApp;
if (tg) { try { tg.expand(); } catch(e){} }
function haptic(type='light'){ try{ tg?.HapticFeedback?.impactOccurred?.(type); }catch(e){} }

/* –§–æ–ª–±—ç–∫ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –º–æ–Ω–µ—Ç—ã */
const coinImg = document.getElementById('coinIcon');
if (coinImg) {
  coinImg.onerror = () => {
    const span = document.createElement('span');
    span.textContent = 'üü°';
    span.style.fontSize = '22px';
    coinImg.replaceWith(span);
  };
}

/* ===== –≠–∫–æ–Ω–æ–º–∏–∫–∞ (–∫–∞–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ) ===== */
const base = { tapBase: 1 };

const RARITY = {
  common:      { hpsPerLvl: 1,   cost0: 30,      costK: 1.16 },
  uncommon:    { hpsPerLvl: 2,   cost0: 300,     costK: 1.20 },
  rare:        { hpsPerLvl: 5,   cost0: 2000,    costK: 1.24 },
  epic:        { hpsPerLvl: 10,  cost0: 15000,   costK: 1.28 },
  legendary:   { hpsPerLvl: 20,  cost0: 120000,  costK: 1.32 },
};

/* –ï–î–ê ‚Äî —Ä–∞–∑–¥–µ–ª—ã –∏ –ø–æ–∑–∏—Ü–∏–∏ */
const FOOD_SECTIONS = [
  {
    title: "–ë–∞–∑–∞",
    items: [
      { key:"base_hay", name:"–°–µ–Ω–æ",  icon:"assets/items/base_hay.png",  type:"hps",
        rarity:"common", override:{ cost0: 15, costK: 1.18, hpsPerLvl:1 } },
      { key:"base_water", name:"–í–æ–¥–∞", icon:"assets/items/base_water.png", type:"mult",
        multPerLvl: null, /* —Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –Ω–∏–∂–µ */ override:{ cost0: 400, costK: 1.32 } },
      { key:"base_feed", name:"–ö–æ—Ä–º", icon:"assets/items/base_feed.png", type:"tap_add",
        tapAddPerLvl:1, rarity:"uncommon", override:{ cost0: 300, costK: 1.24 } }
    ]
  },
  {
    title: "–ó–µ–ª–µ–Ω—É—à–∫–∞",
    items: [
      { key:"greens_salad",   name:"–°–∞–ª–∞—Ç ¬´–í—ã–±–æ—Ä–∂–µ—Ü¬ª", icon:"assets/items/greens_salad.png",   type:"hps", rarity:"common"   },
      { key:"greens_dill",    name:"–£–∫—Ä–æ–ø",            icon:"assets/items/greens_dill.png",    type:"hps", rarity:"common"   },
      { key:"greens_parsley", name:"–ü–µ—Ç—Ä—É—à–∫–∞",         icon:"assets/items/greens_parsley.png", type:"hps", rarity:"uncommon" },
      { key:"greens_basil",   name:"–ë–∞–∑–∏–ª–∏–∫",          icon:"assets/items/greens_basil.png",   type:"hps", rarity:"rare"     },
      { key:"greens_mint",    name:"–ú—è—Ç–∞",             icon:"assets/items/greens_mint.png",    type:"hps", rarity:"uncommon" },
      { key:"greens_broccoli",name:"–ë—Ä–æ–∫–∫–æ–ª–∏",         icon:"assets/items/greens_broccoli.png",type:"hps", rarity:"rare"     },
    ]
  },
  {
    title: "–û–≤–æ—â–∏",
    items: [
      { key:"veg_carrot",     name:"–ú–æ—Ä–∫–æ–≤—å",          icon:"assets/items/veg_carrot.png",     type:"hps", rarity:"common"   },
      { key:"veg_celery",     name:"–°–µ–ª—å–¥–µ—Ä–µ–π",        icon:"assets/items/veg_celery.png",     type:"hps", rarity:"uncommon" },
      { key:"veg_cucumber",   name:"–û–≥—É—Ä–µ—Ü",           icon:"assets/items/veg_cucumber.png",   type:"hps", rarity:"common"   },
      { key:"veg_pepper",     name:"–ë–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü", icon:"assets/items/veg_pepper.png",     type:"hps", rarity:"rare"     },
    ]
  },
  {
    title: "–§—Ä—É–∫—Ç—ã",
    items: [
      { key:"fruit_apple",    name:"–Ø–±–ª–æ–∫–∏",   icon:"assets/items/fruit_apple.png",    type:"hps", rarity:"common"   },
      { key:"fruit_pear",     name:"–ì—Ä—É—à–∞",    icon:"assets/items/fruit_pear.png",     type:"hps", rarity:"uncommon" },
      { key:"fruit_apricot",  name:"–ê–±—Ä–∏–∫–æ—Å—ã", icon:"assets/items/fruit_apricot.png",  type:"hps", rarity:"rare"     },
    ]
  },
  {
    title: "–Ø–≥–æ–¥—ã",
    items: [
      { key:"berry_currant",   name:"–ß—ë—Ä–Ω–∞—è —Å–º–æ—Ä–æ–¥–∏–Ω–∞", icon:"assets/items/berry_currant.png",   type:"hps", rarity:"rare"     },
      { key:"berry_raspberry", name:"–ú–∞–ª–∏–Ω–∞",            icon:"assets/items/berry_raspberry.png", type:"hps", rarity:"uncommon" },
      { key:"berry_blackberry",name:"–ï–∂–µ–≤–∏–∫–∞",           icon:"assets/items/berry_blackberry.png",type:"hps", rarity:"rare"     },
      { key:"berry_gooseberry",name:"–ö—Ä—ã–∂–æ–≤–Ω–∏–∫",         icon:"assets/items/berry_gooseberry.png",type:"hps", rarity:"uncommon" },
    ]
  },
];

/* –ö–ê–†–¢–û–ß–ö–ò ‚Äî —Ä–∞–∑–æ–≤—ã–µ –ø–æ–∫—É–ø–∫–∏ (+1 –∫ –¥–æ—Ö–æ–¥—É –∑–∞ —Ç–∞–ø, —Å—É–º–º–∏—Ä—É—é—Ç—Å—è, –º–Ω–æ–∂–∞—Ç—Å—è ¬´–í–æ–¥–æ–π¬ª) */
const CARDS = [
  {
    key: "card_nails",
    name: "–ü–æ–¥—Å—Ç—Ä–∏–∂–µ–Ω–Ω—ã–µ –Ω–æ–≥–æ—Ç–æ—á–∫–∏",
    icon: "assets/cards/card_nails.png",
    desc: "–ö—Ä–∞—Å–∏–≤—ã–µ –Ω–æ–≥–æ—Ç–æ—á–∫–∏ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ –∫—Ä–∞—Å–æ—Ç—É –∏ —É—Ö–æ–¥ –∑–∞ —Å–æ–±–æ–π",
    cost: 5000,
    tapBonus: 1,
  },
];

/* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ/—ç–ª–µ–º–µ–Ω—Ç—ã ===== */
const els = {
  balance: document.getElementById('balance'),
  hps: document.getElementById('hps'),
  perTap: document.getElementById('perTap'),
  waterBuff: document.getElementById('waterBuff'),
  tapBtn: document.getElementById('tapBtn'),
  reset: document.getElementById('reset'),
  foodRoot: document.getElementById('foodRoot'),
  cardsRoot: document.getElementById('cardsRoot'),
  tabFood: document.getElementById('tabFood'),
  tabCards: document.getElementById('tabCards'),
  viewFood: document.getElementById('viewFood'),
  viewCards: document.getElementById('viewCards'),
};

const storeKey = 'rabbit_clicker_tabs_food_cards';
let S = load() || makeFreshState();

/* ===== Save/Load ===== */
function makeFreshState(){
  const levels = {};
  for (const sec of FOOD_SECTIONS) for (const it of sec.items) levels[it.key] = 0;
  const cards = {};
  for (const c of CARDS) cards[c.key] = false;
  return { happy: 0, last: Date.now(), levels, cards };
}
function save(){ localStorage.setItem(storeKey, JSON.stringify(S)); }
function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)||''); }catch(e){ return null; } }

/* Utils */
function fmt(n){
  if (n < 1000) return Math.floor(n).toString();
  const units = ['K','M','B','T','Q'];
  let u = -1, v = n;
  while (v >= 1000 && u < units.length-1){ v/=1000; u++; }
  return (Math.floor(v*10)/10).toFixed(1).replace(/\.0$/,'') + units[u];
}
function getLevel(key){ return S.levels[key] || 0; }
function setLevel(key, lvl){ S.levels[key] = lvl; }
function isCardBought(key){ return !!S.cards[key]; }
function setCardBought(key, val){ S.cards[key] = !!val; }

function itemCost0(item){ return item.override?.cost0 ?? RARITY[item.rarity].cost0; }
function itemBaseCostK(item){ return item.override?.costK ?? RARITY[item.rarity].costK; }
function itemHpsPerLvl(item){ if (item.type!=='hps') return 0; return item.override?.hpsPerLvl ?? RARITY[item.rarity].hpsPerLvl; }

/* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏: –∫–∞–∂–¥—ã–µ 10 —É—Ä–æ–≤–Ω–µ–π +0.01 –∫ costK */
function costKAt(item, lvlIndex){
  const baseK = itemBaseCostK(item);
  const bump = Math.floor(lvlIndex/10) * 0.01;
  return baseK + bump;
}
function nextPrice(item, currentLvl){
  let price = itemCost0(item);
  for (let i=0;i<currentLvl;i++) price *= costKAt(item,i);
  return Math.floor(price);
}

/* –£–±—ã–≤–∞—é—â–∞—è –æ—Ç–¥–∞—á–∞ —É—Ä–æ–≤–Ω–µ–π */
function effLevel(lvl){
  if (lvl <= 25) return lvl;
  if (lvl <= 100) return 25 + Math.pow(lvl-25, 0.85);
  return 25 + Math.pow(75,0.85) + Math.pow(lvl-100, 0.75);
}

/* –í–æ–¥–∞: √ó1.12 / √ó1.07 / √ó1.04 */
function waterMult(){
  const lvl = getLevel('base_water');
  const a = Math.min(lvl, 10);
  const b = Math.min(Math.max(lvl-10,0), 10);
  const c = Math.max(lvl-20, 0);
  return Math.pow(1.12, a) * Math.pow(1.07, b) * Math.pow(1.04, c);
}

/* –ö–æ—Ä–º ‚Üí —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–π –≤–∫–ª–∞–¥ –∫ —Ç–∞–ø—É */
function tapAddFromFeed(){
  const feed = FOOD_SECTIONS[0].items.find(i=>i.key==='base_feed');
  const perLvl = (feed?.tapAddPerLvl)||1;
  const lvl = getLevel('base_feed');
  const raw = perLvl * effLevel(lvl);
  return Math.floor(raw);
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Üí —Å—É–º–º–∞—Ä–Ω—ã–π –±–æ–Ω—É—Å –∫ —Ç–∞–ø—É */
function cardsTapBonus(){
  let sum = 0;
  for (const c of CARDS) if (isCardBought(c.key)) sum += (c.tapBonus||0);
  return sum;
}

/* –î–æ—Ö–æ–¥ –∑–∞ —Ç–∞–ø (–±–∞–∑–∞ + –∫–æ—Ä–º + –∫–∞—Ä—Ç–æ—á–∫–∏) * –≤–æ–¥–∞ */
function perTap(){
  const baseSum = base.tapBase + tapAddFromFeed() + cardsTapBonus();
  const raw = baseSum * waterMult();
  return Math.max(1, Math.floor(raw));
}

/* –ü–∞—Å—Å–∏–≤–∫–∞ ‚Üí —Å—É–º–º–∞ –ø–æ ¬´hps¬ª –ø–æ–∑–∏—Ü–∏—è–º * –≤–æ–¥–∞ */
function totalHps(){
  let total = 0;
  for (const sec of FOOD_SECTIONS){
    for (const it of sec.items){
      if (it.type === 'hps'){
        const lvl = getLevel(it.key);
        const raw = itemHpsPerLvl(it) * effLevel(lvl);
        total += Math.floor(raw);
      }
    }
  }
  return Math.floor(total * waterMult());
}

/* Offline –∫–∞–ø: 2 —á–∞—Å–∞ */
(function offlineGain(){
  const now = Date.now();
  const dt = Math.max(0, (now - (S.last||now))/1000);
  const capped = Math.min(dt, 2*3600);
  const gain = totalHps() * capped;
  if (gain > 0) S.happy += gain;
  S.last = now;
})();

/* ===== –†–µ–Ω–¥–µ—Ä –ï–î–´ ===== */
function makeFoodItemCard(item){
  const lvl = getLevel(item.key);
  const card = document.createElement('div');
  card.className = 'card';

  const icon = document.createElement('div');
  icon.className = 'icon-wrap';
  const img = document.createElement('img');
  img.src = item.icon;
  img.alt = item.name;
  icon.appendChild(img);

  const main = document.createElement('div');
  main.className = 'c-main';

  const title = document.createElement('div');
  title.className = 'c-title';
  title.innerHTML = `${item.name} <span class="lvl">—É—Ä. <span data-lvl="${item.key}">${lvl}</span></span>`;

  const sub = document.createElement('div');
  sub.className = 'c-sub';
  if (item.type === 'hps'){
    const inc = Math.floor(itemHpsPerLvl(item) * waterMult());
    sub.textContent = `–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: +${inc} Happy/—Å–µ–∫ –∑–∞ —É—Ä. (—Å —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–µ–π)`;
  } else if (item.type === 'mult'){
    sub.textContent = `–í–æ–¥–∞: —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∞—á–∞–ª–µ, —Å–ª–∞–±–µ–µ –ø–æ–∑–∂–µ`;
  } else if (item.type === 'tap_add'){
    const add = Math.floor(((item.tapAddPerLvl||1) * waterMult()));
    sub.textContent = `–î–æ—Ö–æ–¥ —Å —Ç–∞–ø–∞: +${add} –∑–∞ —É—Ä. (—Å —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–µ–π)`;
  }

  const row = document.createElement('div');
  row.className = 'row';

  const mini = document.createElement('div');
  mini.className = 'mini';
  mini.innerHTML = renderFoodMini(item);

  const btn = document.createElement('button');
  btn.className = 'buy' + (item.type==='mult' ? ' blue' : '');
  btn.textContent = '–ö—É–ø–∏—Ç—å';
  btn.dataset.key = item.key;

  row.appendChild(mini);
  row.appendChild(btn);

  main.appendChild(title);
  main.appendChild(sub);
  main.appendChild(row);

  card.appendChild(icon);
  card.appendChild(main);
  return card;
}

function renderFoodMini(item){
  const lvl = getLevel(item.key);
  const price = nextPrice(item, lvl);
  if (item.type === 'hps'){
    const inc = Math.floor(itemHpsPerLvl(item) * waterMult());
    return `+${inc}/—Å–µ–∫ –∑–∞ —É—Ä. ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(price)}`;
  } else if (item.type === 'mult'){
    const mult = waterMult();
    const buff = (mult-1)*100;
    return `–±–∞—Ñ —Å–µ–π—á–∞—Å: ${Math.floor(buff)}% ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(price)}`;
  } else if (item.type === 'tap_add'){
    const add = Math.floor(((item.tapAddPerLvl||1) * waterMult()));
    return `+${add} –∑–∞ —Ç–∞–ø/—É—Ä. ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(price)}`;
  }
  return `—Ü–µ–Ω–∞: üü° ${fmt(price)}`;
}

function renderFood(){
  els.foodRoot.innerHTML = '';
  // —Ä–∏—Å—É–µ–º –≤—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã –≤–Ω—É—Ç—Ä–∏ –≤–∫–ª–∞–¥–∫–∏ "–ï–¥–∞"
  for (const sec of FOOD_SECTIONS){
    const box = document.createElement('div');
    box.className = 'section';
    const h = document.createElement('h3');
    h.textContent = sec.title;
    box.appendChild(h);

    const container = document.createElement('div');
    container.className = 'store';
    for (const it of sec.items){
      container.appendChild( makeFoodItemCard(it) );
    }
    box.appendChild(container);
    els.foodRoot.appendChild(box);
  }

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∫—É–ø–∫–∏
  els.foodRoot.querySelectorAll('.buy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.key;
      let item = null;
      for (const sec of FOOD_SECTIONS){ item = sec.items.find(i=>i.key===key) || item; }
      if (!item) return;
      const lvl = getLevel(key);
      const price = nextPrice(item, lvl);
      if (S.happy >= price){
        S.happy -= price;
        setLevel(key, lvl+1);
        haptic('medium');
        updateUI(); save();
      }
    });
  });
}

/* ===== –†–µ–Ω–¥–µ—Ä –ö–ê–†–¢–û–ß–ï–ö ===== */
function renderCards(){
  els.cardsRoot.innerHTML = '';
  for (const c of CARDS){
    const card = document.createElement('div');
    card.className = 'kcard';

    const pic = document.createElement('div');
    pic.className = 'pic';
    const img = document.createElement('img');
    img.src = c.icon;
    img.alt = c.name;
    pic.appendChild(img);

    const body = document.createElement('div');
    body.className = 'body';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = c.name;

    const desc = document.createElement('div');
    desc.className = 'desc';
    desc.textContent = c.desc;

    const row = document.createElement('div');
    row.className = 'row';

    const mini = document.createElement('div');
    mini.className = 'mini';
    mini.innerHTML = `+${c.tapBonus} –∑–∞ —Ç–∞–ø ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(c.cost)}`;

    const btn = document.createElement('button');
    btn.className = 'buy';
    btn.textContent = isCardBought(c.key) ? '–ö—É–ø–ª–µ–Ω–æ' : '–ö—É–ø–∏—Ç—å';
    btn.disabled = isCardBought(c.key);
    btn.dataset.key = c.key;

    row.appendChild(mini);
    row.appendChild(btn);

    body.appendChild(title);
    body.appendChild(desc);
    body.appendChild(row);

    card.appendChild(pic);
    card.appendChild(body);
    els.cardsRoot.appendChild(card);
  }

  // –ø–æ–∫—É–ø–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
  els.cardsRoot.querySelectorAll('.buy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.key;
      const c = CARDS.find(x=>x.key===key);
      if (!c) return;
      if (isCardBought(key)) return;
      if (S.happy >= c.cost){
        S.happy -= c.cost;
        setCardBought(key, true);
        haptic('medium');
        updateUI(); save();
      }
    });
  });
}

/* ===== Tabs ===== */
function setActiveTab(name){
  const isFood = name === 'food';
  els.tabFood.classList.toggle('active', isFood);
  els.tabCards.classList.toggle('active', !isFood);
  els.viewFood.classList.toggle('active', isFood);
  els.viewCards.classList.toggle('active', !isFood);
  localStorage.setItem('rc_active_tab2', isFood ? 'food' : 'cards');
}
els.tabFood.addEventListener('click', ()=> setActiveTab('food'));
els.tabCards.addEventListener('click', ()=> setActiveTab('cards'));

/* ===== –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä ===== */
function updateHeader(){
  els.balance.textContent = fmt(S.happy);
  els.hps.textContent = totalHps();         // —Ü–µ–ª–æ–µ
  els.perTap.textContent = perTap();        // —Ü–µ–ª–æ–µ
  els.waterBuff.textContent = Math.floor((waterMult()-1)*100);
}
function updateFoodRows(){
  // —É—Ä–æ–≤–Ω–∏
  for (const sec of FOOD_SECTIONS) for (const it of sec.items){
    const sp = document.querySelector(`[data-lvl="${it.key}"]`);
    if (sp) sp.textContent = getLevel(it.key);
  }
  // –º–∏–Ω–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
  for (const sec of FOOD_SECTIONS) for (const it of sec.items){
    const cards = Array.from(els.foodRoot.querySelectorAll('.card'));
    const card = cards.find(c=>{
      const t = c.querySelector('.c-title')?.textContent||'';
      return t.includes(it.name);
    });
    if (!card) continue;
    const mini = card.querySelector('.mini');
    if (mini) mini.innerHTML = renderFoodMini(it);
    const btn = card.querySelector('.buy');
    if (btn){
      const price = nextPrice(it, getLevel(it.key));
      btn.disabled = S.happy < price;
    }
  }
}
function updateCardsRows(){
  els.cardsRoot.querySelectorAll('.kcard').forEach((node, idx)=>{
    const c = CARDS[idx];
    const btn = node.querySelector('.buy');
    const mini = node.querySelector('.mini');
    if (mini) mini.innerHTML = `+${c.tapBonus} –∑–∞ —Ç–∞–ø ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(c.cost)}`;
    if (btn){
      const bought = isCardBought(c.key);
      btn.textContent = bought ? '–ö—É–ø–ª–µ–Ω–æ' : '–ö—É–ø–∏—Ç—å';
      btn.disabled = bought || S.happy < c.cost;
      node.classList.toggle('bought', bought);
    }
  });
}
function updateUI(){
  updateHeader();
  updateFoodRows();
  updateCardsRows();
}

/* ===== –¢–∏–∫ ===== */
let acc = 0, lastTs = performance.now();
function loop(ts){
  const dt = (ts - lastTs)/1000; lastTs = ts;
  acc += dt;
  const step = 0.1;
  while (acc >= step){
    S.happy += totalHps() * step;
    acc -= step;
  }
  if (Math.random() < 0.02){ S.last = Date.now(); save(); }
  updateUI();
  requestAnimationFrame(loop);
}

/* ===== –°–æ–±—ã—Ç–∏—è ===== */
els.tapBtn.addEventListener('click', ()=>{
  const gain = perTap();
  S.happy += gain;
  popText(els.tapBtn, `+${gain}`);
  haptic('light');
  updateUI();
});

els.reset.addEventListener('click', ()=>{
  if (!confirm('–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
  S = makeFreshState();
  save();
  renderFood();
  renderCards();
  updateUI();
});

/* –í—Å–ø–ª—ã–≤–∞—à–∫–∞ */
function popText(anchorEl, text){
  const r = anchorEl.getBoundingClientRect();
  const b = document.createElement('div');
  b.textContent = text;
  b.style.position='fixed';
  b.style.left = (r.left + r.width/2) + 'px';
  b.style.top  = (r.top + r.height/2) + 'px';
  b.style.transform='translate(-50%,-50%)';
  b.style.pointerEvents='none';
  b.style.color='#fff';
  b.style.textShadow='0 2px 10px rgba(0,0,0,.6)';
  b.style.fontWeight='700';
  b.style.transition='all .6s ease';
  document.body.appendChild(b);
  requestAnimationFrame(()=>{
    b.style.top = (r.top - 30) + 'px';
    b.style.opacity = '0';
    b.style.scale = '1.2';
  });
  setTimeout(()=> b.remove(), 650);
}

/* ===== –°—Ç–∞—Ä—Ç ===== */
renderFood();
renderCards();
updateUI();
const savedTab = localStorage.getItem('rc_active_tab2');
setActiveTab(savedTab === 'cards' ? 'cards' : 'food');
requestAnimationFrame(loop);
</script>
</body>
</html>
