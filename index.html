<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>RabbitCoin clicker</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1730; --card:#111d3b; --muted:#9fb0d0; --accent:#1fa37c; --accent2:#2b6cb0;
    --tab:#0f1730; --tabActive:#1b2a56;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:480px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}

  .header{display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-radius:16px;padding:12px 14px}
  .balance{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .coin-img{width:22px;height:22px;object-fit:contain;vertical-align:middle}
  .sub{font-size:12px;color:var(--muted)}

  .tap{background:linear-gradient(180deg,#12254f,#0f1834);border-radius:16px;padding:16px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .tap-btn{
    width:100%; aspect-ratio:1/1; border-radius:50%; overflow:hidden; border:0;
    background:radial-gradient(100% 100% at 50% 35%,#1a2b5f 0%,#14224a 60%,#0f1834 100%);
    display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    box-shadow:inset 0 6px 18px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.4);
  }
  .tap-btn:active{transform:scale(.98)}
  .tap-btn img{width:88%; height:88%; object-fit:contain; display:block; pointer-events:none}
  .tap-info{margin-top:10px;display:flex;justify-content:space-between;color:var(--muted);font-size:13px}

  /* Tabs */
  .tabs{display:flex;gap:8px;background:transparent}
  .tab{
    flex:1; text-align:center; padding:10px 12px; border-radius:12px; cursor:pointer; user-select:none;
    background:var(--tab); color:#cfd9ff; font-weight:700; border:1px solid #1f2b56;
  }
  .tab.active{background:var(--tabActive); color:#fff; border-color:#2a3a6d; box-shadow:0 4px 16px rgba(0,0,0,.25) inset}
  .views{margin-top:6px}
  .view{display:none}
  .view.active{display:block}

  /* –ï–¥–∞ */
  .section{margin-top:10px}
  .section h3{margin:6px 0 8px; font-size:15px; opacity:.9}
  .store{display:flex;flex-direction:column;gap:10px}
  .card{background:var(--card);border-radius:14px;padding:12px;display:flex;gap:12px;align-items:center}
  .icon-wrap{width:42px;height:42px;border-radius:10px;overflow:hidden;flex:0 0 42px;background:#0f1730;display:flex;align-items:center;justify-content:center}
  .icon-wrap img{width:100%;height:100%;object-fit:contain}
  .c-main{flex:1;min-width:0}
  .c-title{font-weight:700;display:flex;align-items:center;gap:8px}
  .lvl{font-size:11px;color:var(--muted);background:#152147;border-radius:999px;padding:2px 8px}
  .c-sub{font-size:12px;color:var(--muted);margin-top:2px}
  .row{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .mini{font-size:12px;color:var(--muted)}
  .buy{background:var(--accent);border:none;color:#04151f;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;min-width:124px}
  .buy.blue{background:var(--accent2);color:#e8f1ff}
  .buy:disabled{opacity:.5;cursor:not-allowed}

  /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
  .cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:6px}
  .kcard{background:var(--card);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .kcard .pic{width:100%;aspect-ratio:1/1;background:#0f1730;display:flex;align-items:center;justify-content:center}
  .kcard .pic img{width:100%;height:100%;object-fit:cover}
  .kcard .body{padding:10px;display:flex;flex-direction:column;gap:6px}
  .kcard .title{font-weight:700;font-size:14px}
  .kcard .desc{font-size:12px;color:var(--muted);line-height:1.25}
  .kcard .row{margin-top:2px}
  .kcard .buy{width:100%}
  .kcard.bought{opacity:.7;pointer-events:none}

  .footer{margin-top:10px;text-align:center;color:var(--muted);font-size:12px}
  .pill{display:inline-block;background:#152147;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:11px;color:var(--muted)}
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="balance">
        <img id="coinIcon" class="coin-img" src="assets/ui/coin.png" alt="RabbitCoin">
        <span id="balance">0</span> <span class="pill">RabbitCoin</span>
      </div>
      <div class="sub">–≤ —Å–µ–∫: <span id="hps">0</span> ‚Ä¢ –∑–∞ —Ç–∞–ø: <span id="perTap">0</span> ‚Ä¢ –±–∞—Ñ –≤–æ–¥—ã: <span id="waterBuff">0</span>%</div>
    </div>
  </div>

  <div class="tap">
    <button id="tapBtn" class="tap-btn" aria-label="Tap to get RabbitCoin">
      <img id="rabbitImg" src="assets/ui/rabbit_main.png" alt="Rabbit"/>
    </button>
    <div class="tap-info"><div>–¢–∞–ø–∞–π –ø–æ –∫—Ä–æ–ª–∏–∫—É, —á—Ç–æ–±—ã —Ñ–∞—Ä–º–∏—Ç—å RabbitCoin</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div id="tabFood" class="tab active">–ï–¥–∞</div>
    <div id="tabCards" class="tab">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
  </div>

  <div class="views">
    <div id="viewFood" class="view active"><div id="foodRoot"></div></div>
    <div id="viewCards" class="view"><div id="cardsRoot" class="cards-grid"></div></div>
  </div>

  <div class="footer">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Telegram Mini App</div>
</div>

<script>
/* ===== Telegram UX ===== */
const tg = window.Telegram?.WebApp;
if (tg) { try { tg.expand(); } catch(e){} }
function haptic(type='light'){ try{ tg?.HapticFeedback?.impactOccurred?.(type); }catch(e){} }

/* –ò–∫–æ–Ω–∫–∞ –º–æ–Ω–µ—Ç—ã ‚Äî —Ñ–æ–ª–±—ç–∫ */
const coinImg = document.getElementById('coinIcon');
if (coinImg) {
  coinImg.onerror = () => {
    const span = document.createElement('span');
    span.textContent = 'üü°';
    span.style.fontSize = '22px';
    coinImg.replaceWith(span);
  };
}

/* ===== –≠–∫–æ–Ω–æ–º–∏–∫–∞ ===== */
const base = { tapBase: 1 };

const RARITY = {
  common:      { hpsPerLvl: 1,   cost0: 30,      costK: 1.16 },
  uncommon:    { hpsPerLvl: 2,   cost0: 300,     costK: 1.20 },
  rare:        { hpsPerLvl: 5,   cost0: 2000,    costK: 1.24 },
  epic:        { hpsPerLvl: 10,  cost0: 15000,   costK: 1.28 },
  legendary:   { hpsPerLvl: 20,  cost0: 120000,  costK: 1.32 },
};

/* –ï–î–ê */
const FOOD_SECTIONS = [
  {
    title: "–ë–∞–∑–∞",
    items: [
      { key:"base_hay", name:"–°–µ–Ω–æ",  icon:"assets/items/base_hay.png",  type:"hps",
        rarity:"common", override:{ cost0: 15, costK: 1.18, hpsPerLvl:1 } },
      { key:"base_water", name:"–í–æ–¥–∞", icon:"assets/items/base_water.png", type:"mult",
        multPerLvl: null, override:{ cost0: 400, costK: 1.32 } },
      { key:"base_feed", name:"–ö–æ—Ä–º", icon:"assets/items/base_feed.png", type:"tap_add",
        tapAddPerLvl:1, rarity:"uncommon", override:{ cost0: 300, costK: 1.24 } }
    ]
  },
  { title: "–ó–µ–ª–µ–Ω—É—à–∫–∞", items: [
      { key:"greens_salad",   name:"–°–∞–ª–∞—Ç ¬´–í—ã–±–æ—Ä–∂–µ—Ü¬ª", icon:"assets/items/greens_salad.png",   type:"hps", rarity:"common"   },
      { key:"greens_dill",    name:"–£–∫—Ä–æ–ø",            icon:"assets/items/greens_dill.png",    type:"hps", rarity:"common"   },
      { key:"greens_parsley", name:"–ü–µ—Ç—Ä—É—à–∫–∞",         icon:"assets/items/greens_parsley.png", type:"hps", rarity:"uncommon" },
      { key:"greens_basil",   name:"–ë–∞–∑–∏–ª–∏–∫",          icon:"assets/items/greens_basil.png",   type:"hps", rarity:"rare"     },
      { key:"greens_mint",    name:"–ú—è—Ç–∞",             icon:"assets/items/greens_mint.png",    type:"hps", rarity:"uncommon" },
      { key:"greens_broccoli",name:"–ë—Ä–æ–∫–∫–æ–ª–∏",         icon:"assets/items/greens_broccoli.png",type:"hps", rarity:"rare"     },
  ]},
  { title: "–û–≤–æ—â–∏", items: [
      { key:"veg_carrot",     name:"–ú–æ—Ä–∫–æ–≤—å",          icon:"assets/items/veg_carrot.png",     type:"hps", rarity:"common"   },
      { key:"veg_celery",     name:"–°–µ–ª—å–¥–µ—Ä–µ–π",        icon:"assets/items/veg_celery.png",     type:"hps", rarity:"uncommon" },
      { key:"veg_cucumber",   name:"–û–≥—É—Ä–µ—Ü",           icon:"assets/items/veg_cucumber.png",   type:"hps", rarity:"common"   },
      { key:"veg_pepper",     name:"–ë–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü", icon:"assets/items/veg_pepper.png",     type:"hps", rarity:"rare"     },
  ]},
  { title: "–§—Ä—É–∫—Ç—ã", items: [
      { key:"fruit_apple",    name:"–Ø–±–ª–æ–∫–∏",   icon:"assets/items/fruit_apple.png",    type:"hps", rarity:"common"   },
      { key:"fruit_pear",     name:"–ì—Ä—É—à–∞",    icon:"assets/items/fruit_pear.png",     type:"hps", rarity:"uncommon" },
      { key:"fruit_apricot",  name:"–ê–±—Ä–∏–∫–æ—Å—ã", icon:"assets/items/fruit_apricot.png",  type:"hps", rarity:"rare"     },
  ]},
  { title: "–Ø–≥–æ–¥—ã", items: [
      { key:"berry_currant",   name:"–ß—ë—Ä–Ω–∞—è —Å–º–æ—Ä–æ–¥–∏–Ω–∞", icon:"assets/items/berry_currant.png",   type:"hps", rarity:"rare"     },
      { key:"berry_raspberry", name:"–ú–∞–ª–∏–Ω–∞",            icon:"assets/items/berry_raspberry.png", type:"hps", rarity:"uncommon" },
      { key:"berry_blackberry",name:"–ï–∂–µ–≤–∏–∫–∞",           icon:"assets/items/berry_blackberry.png",type:"hps", rarity:"rare"     },
      { key:"berry_gooseberry",name:"–ö—Ä—ã–∂–æ–≤–Ω–∏–∫",         icon:"assets/items/berry_gooseberry.png",type:"hps", rarity:"uncommon" },
  ]},
];

/* –ö–ê–†–¢–û–ß–ö–ò ‚Äî —Ä–∞–∑–æ–≤—ã–µ */
const CARDS = [
  {
    key: "card_nails",
    name: "–ü–æ–¥—Å—Ç—Ä–∏–∂–µ–Ω–Ω—ã–µ –∫–æ–≥–æ—Ç–æ—á–∫–∏",
    icon: "assets/cards/card_nails.png",
    desc: "–ö—Ä–∞—Å–∏–≤—ã–µ –∫–æ–≥–æ—Ç–æ—á–∫–∏ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ –∫—Ä–∞—Å–æ—Ç—É –∏ —É—Ö–æ–¥ –∑–∞ —Å–æ–±–æ–π",
    cost: 5000,
    tapBonus: 1,
  },
  {
    key: "card_castration",
    name: "–ö–∞—Å—Ç—Ä–∞—Ü–∏—è",
    icon: "assets/cards/card_castration.png",
    desc: "–†–æ–¥–∏—Ç–µ–ª–∏ —Å–∫–∞–∑–∞–ª–∏, —á—Ç–æ —Ç–∞–∫ –±—É–¥–µ—Ç –ª—É—á—à–µ...",
    cost: 10000,
    tapBonus: 1,
  },
  {
    key: "card_vaccination",
    name: "–í–∞–∫—Ü–∏–Ω–∞—Ü–∏—è",
    icon: "assets/cards/card_vaccination.png",
    desc: "–ß—Ç–æ–±—ã –ø–æ–±–µ–∂–¥–∞—Ç—å, –Ω—É–∂–Ω–æ –≤—Å–µ–≥–¥–∞ –±—ã—Ç—å –Ω–∞ –ø–∞—Ä—É —à–∞–≥–æ–≤ –≤–ø–µ—Ä–µ–¥–∏",
    cost: 20000,
    tapBonus: 1,
  },
  {
    key: "card_checkup",
    name: "–ü–æ–ª–Ω—ã–π —á–µ–∫–∞–ø",
    icon: "assets/cards/card_checkup.png",
    desc: "–†–∞—Å—á–µ—Ö–ª—è–µ–º –∫–æ—à–µ–ª—å–∫–∏",
    cost: 40000,
    tapBonus: 1,
  },

  /* –Ω–æ–≤—ã–µ */
  {
    key: "card_pp",
    name: "–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ü–ü",
    icon: "assets/cards/card_pp.png",
    desc: "–í –∑–¥–æ—Ä–æ–≤–æ–º —Ç–µ–ª–µ - –∑–¥–æ—Ä–æ–≤—ã–π –¥—É—Ö!",
    cost: 80000,
    tapBonus: 1,
  },
  {
    key: "card_shedding",
    name: "–ë–æ—Ä—å–±–∞ —Å –ª–∏–Ω—å–∫–æ–π",
    icon: "assets/cards/card_shedding.png",
    desc: "–í—ã—á–µ—Å–∞—Ç—å —à–µ—Ä—Å—Ç—å",
    cost: 160000,
    tapBonus: 1,
  },
  {
    key: "card_passport",
    name: "–°–¥–µ–ª–∞—Ç—å –∑–∞–≥—Ä–∞–Ω–∏—á–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç",
    icon: "assets/cards/card_passport.png",
    desc: "–ö–∞–∂–¥—ã–π —É–≤–∞–∂–∞—é—â–∏–π —Å–µ–±—è –∫—Ä–æ–ª–∏–∫ –¥–æ–ª–∂–µ–Ω –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å",
    cost: 320000,
    tapBonus: 1,
  },
  {
    key: "card_companion",
    name: "–û–±–∑–∞–≤–µ—Å—Ç–∏—Å—å —Å–æ—Ä–æ–¥–∏—á–µ–º",
    icon: "assets/cards/card_companion.png",
    desc: "–ú–Ω–µ –Ω—É–∂–µ–Ω —Ç–æ—Ç, –∫—Ç–æ –≤—Å–µ–≥–¥–∞ –º–µ–Ω—è –ø–æ–π–º–µ—Ç",
    cost: 640000,
    tapBonus: 1,
  },
  {
    key: "card_move_abroad",
    name: "–ü–µ—Ä–µ–µ—Ö–∞—Ç—å –∑–∞–≥—Ä–∞–Ω–∏—Ü—É",
    icon: "assets/cards/card_move_abroad.png",
    desc: "–Ø —É—Å—Ç–∞–ª –æ—Ç –ø—Ä–µ–¥–∫–æ–≤...",
    cost: 1280000,
    tapBonus: 1,
  },
];


/* ===== DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ===== */
const els = {
  balance: document.getElementById('balance'),
  hps: document.getElementById('hps'),
  perTap: document.getElementById('perTap'),
  waterBuff: document.getElementById('waterBuff'),
  tapBtn: document.getElementById('tapBtn'),
  foodRoot: document.getElementById('foodRoot'),
  cardsRoot: document.getElementById('cardsRoot'),
  tabFood: document.getElementById('tabFood'),
  tabCards: document.getElementById('tabCards'),
  viewFood: document.getElementById('viewFood'),
  viewCards: document.getElementById('viewCards'),
};

/* ===== –ù–∞–¥—ë–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π ===== */
const storeKey = 'rabbit_clicker_tabs_food_cards';
const legacyKeys = ['rabbit_clicker_v2','rabbit_clicker_tabs_food','rabbit_clicker_v1'];

function makeFreshState(){
  const levels = {};
  for (const sec of FOOD_SECTIONS) for (const it of sec.items) levels[it.key] = 0;
  const cards = {};
  for (const c of CARDS) cards[c.key] = false;
  return { RabbitCoin: 0, last: Date.now(), levels, cards };
}
function safeParse(j){ try{ return JSON.parse(j); }catch{ return null; } }
function ensureShape(S){
  const t = (S && typeof S==='object') ? S : {};
  if (typeof t.RabbitCoin!=='number') t.RabbitCoin = 0;
  if (typeof t.last!=='number') t.last = Date.now();
  if (!t.levels || typeof t.levels!=='object') t.levels = {};
  for (const sec of FOOD_SECTIONS) for (const it of sec.items)
    if (typeof t.levels[it.key]!=='number') t.levels[it.key]=0;
  if (!t.cards || typeof t.cards!=='object') t.cards = {};
  for (const c of CARDS)
    if (typeof t.cards[c.key]!=='boolean') t.cards[c.key]=false;
  return t;
}
function migrateFrom(old){
  const fresh = makeFreshState();
  if (!old || typeof old!=='object') return fresh;
  fresh.RabbitCoin = Number(old.RabbitCoin ?? old.happy ?? 0);
  fresh.last = Number(old.last ?? Date.now());
  const srcL = old.levels || {};
  for (const k in srcL){
    if (fresh.levels.hasOwnProperty(k)) fresh.levels[k] = Number(srcL[k]||0);
  }
  const srcC = old.cards || {};
  for (const k in srcC){
    if (fresh.cards.hasOwnProperty(k)) fresh.cards[k] = !!srcC[k];
  }
  return fresh;
}
function loadOrInit(){
  const raw = localStorage.getItem(storeKey);
  if (raw) return ensureShape(safeParse(raw)) || makeFreshState();
  for (const key of legacyKeys){
    const r = localStorage.getItem(key);
    if (r){
      const migrated = ensureShape(migrateFrom(safeParse(r)));
      localStorage.setItem(storeKey, JSON.stringify(migrated));
      return migrated;
    }
  }
  return makeFreshState();
}
let S = loadOrInit();
function save(){ try{ localStorage.setItem(storeKey, JSON.stringify(S)); }catch{} }

/* ===== –£—Ç–∏–ª–∏—Ç—ã ===== */
function fmt(n){
  if (n < 1000) return Math.floor(n).toString();
  const units = ['K','M','B','T','Q'];
  let u=-1, v=n;
  while (v>=1000 && u<units.length-1){ v/=1000; u++; }
  return (Math.floor(v*10)/10).toFixed(1).replace(/\.0$/,'')+units[u];
}
function getLevel(key){ return S.levels[key]||0; }
function setLevel(key,lvl){ S.levels[key]=lvl; }
function isCardBought(key){ return !!S.cards[key]; }
function setCardBought(key,val){ S.cards[key]=!!val; }

function itemCost0(item){ return item.override?.cost0 ?? RARITY[item.rarity].cost0; }
function itemBaseCostK(item){ return item.override?.costK ?? RARITY[item.rarity].costK; }
function itemHpsPerLvl(item){ return item.type==='hps' ? (item.override?.hpsPerLvl ?? RARITY[item.rarity].hpsPerLvl) : 0; }

/* –°—Ç–æ–∏–º–æ—Å—Ç—å: –∫–∞–∂–¥—ã–µ 10 —É—Ä–æ–≤–Ω–µ–π +0.01 –∫ K */
function costKAt(item, idx){ return itemBaseCostK(item) + Math.floor(idx/10)*0.01; }
function nextPrice(item, lvl){ let p=itemCost0(item); for(let i=0;i<lvl;i++) p*=costKAt(item,i); return Math.floor(p); }

/* –£–±—ã–≤–∞—é—â–∞—è –æ—Ç–¥–∞—á–∞ —É—Ä–æ–≤–Ω–µ–π */
function effLevel(lvl){
  if (lvl<=25) return lvl;
  if (lvl<=100) return 25 + Math.pow(lvl-25,0.85);
  return 25 + Math.pow(75,0.85) + Math.pow(lvl-100,0.75);
}

/* –í–æ–¥–∞ ‚Äî —Å—Ç—É–ø–µ–Ω–∏ */
function waterMult(){
  const lvl=getLevel('base_water');
  const a=Math.min(lvl,10), b=Math.min(Math.max(lvl-10,0),10), c=Math.max(lvl-20,0);
  return Math.pow(1.12,a)*Math.pow(1.07,b)*Math.pow(1.04,c);
}

/* –ö–æ—Ä–º ‚Üí –≤–∫–ª–∞–¥ –≤ —Ç–∞–ø (—Ü–µ–ª—ã–µ) */
function tapAddFromFeed(){
  const per=(FOOD_SECTIONS[0].items.find(i=>i.key==='base_feed')?.tapAddPerLvl)||1;
  return Math.floor(per * effLevel(getLevel('base_feed')));
}
/* –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Üí –±–æ–Ω—É—Å –∫ —Ç–∞–ø—É */
function cardsTapBonus(){ return CARDS.reduce((s,c)=>s+(isCardBought(c.key)?(c.tapBonus||0):0),0); }

/* –î–æ—Ö–æ–¥—ã */
function perTap(){ return Math.max(1, Math.floor((base.tapBase + tapAddFromFeed() + cardsTapBonus())*waterMult())); }
function totalHps(){
  let t=0;
  for (const sec of FOOD_SECTIONS) for (const it of sec.items){
    if (it.type==='hps'){ t += Math.floor(itemHpsPerLvl(it)*effLevel(getLevel(it.key))); }
  }
  return Math.floor(t*waterMult());
}

/* Offline-–¥–æ—Ö–æ–¥ (–∫–∞–ø 2—á) */
(function(){
  const now=Date.now(), dt=Math.max(0,(now-(S.last||now))/1000), capped=Math.min(dt,2*3600);
  const gain=totalHps()*capped; if (gain>0) S.RabbitCoin+=gain; S.last=now;
})();

/* ===== –†–µ–Ω–¥–µ—Ä: –ï–î–ê ===== */
function makeFoodItemCard(item){
  const card=document.createElement('div'); card.className='card';
  const icon=document.createElement('div'); icon.className='icon-wrap';
  const img=document.createElement('img'); img.src=item.icon; img.alt=item.name; icon.appendChild(img);

  const main=document.createElement('div'); main.className='c-main';
  const title=document.createElement('div'); title.className='c-title';
  title.innerHTML=`${item.name} <span class="lvl">—É—Ä. <span data-lvl="${item.key}">${getLevel(item.key)}</span></span>`;

  const sub=document.createElement('div'); sub.className='c-sub';
  if (item.type==='hps'){
    sub.textContent=`–î–æ—Ö–æ–¥: +${Math.floor(itemHpsPerLvl(item)*waterMult())} RabbitCoin/—Å–µ–∫ –∑–∞ —É—Ä.`;
  }else if(item.type==='mult'){ sub.textContent='–í–æ–¥–∞: —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∞—á–∞–ª–µ, —Å–ª–∞–±–µ–µ –ø–æ–∑–∂–µ';
  }else{ sub.textContent=`–î–æ—Ö–æ–¥ —Å —Ç–∞–ø–∞: +${Math.floor(((item.tapAddPerLvl||1)*waterMult()))} –∑–∞ —É—Ä. (—Å —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–µ–π)`; }

  const row=document.createElement('div'); row.className='row';
  const mini=document.createElement('div'); mini.className='mini'; mini.innerHTML=renderFoodMini(item);
  const btn=document.createElement('button'); btn.className='buy'+(item.type==='mult'?' blue':''); btn.textContent='–ö—É–ø–∏—Ç—å'; btn.dataset.key=item.key;

  row.appendChild(mini); row.appendChild(btn);
  main.appendChild(title); main.appendChild(sub); main.appendChild(row);
  card.appendChild(icon); card.appendChild(main);
  return card;
}
function renderFoodMini(item){
  const lvl=getLevel(item.key), price=nextPrice(item,lvl);
  if (item.type==='hps'){ return `+${Math.floor(itemHpsPerLvl(item)*waterMult())}/—Å–µ–∫ –∑–∞ —É—Ä. ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(price)}`; }
  if (item.type==='mult'){ const buff=(waterMult()-1)*100; return `–±–∞—Ñ —Å–µ–π—á–∞—Å: ${Math.floor(buff)}% ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(price)}`; }
  return `+${Math.floor(((item.tapAddPerLvl||1)*waterMult()))} –∑–∞ —Ç–∞–ø/—É—Ä. ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(price)}`;
}
function renderFood(){
  els.foodRoot.innerHTML='';
  for (const sec of FOOD_SECTIONS){
    const box=document.createElement('div'); box.className='section';
    const h=document.createElement('h3'); h.textContent=sec.title; box.appendChild(h);
    const container=document.createElement('div'); container.className='store';
    for (const it of sec.items){ container.appendChild(makeFoodItemCard(it)); }
    box.appendChild(container); els.foodRoot.appendChild(box);
  }
  els.foodRoot.querySelectorAll('.buy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key=btn.dataset.key;
      let item=null; for (const sec of FOOD_SECTIONS){ item = sec.items.find(i=>i.key===key) || item; }
      if (!item) return;
      const lvl=getLevel(key), price=nextPrice(item,lvl);
      if (S.RabbitCoin>=price){ S.RabbitCoin-=price; setLevel(key,lvl+1); haptic('medium'); updateUI(); save(); }
    });
  });
}

/* ===== –†–µ–Ω–¥–µ—Ä: –ö–ê–†–¢–û–ß–ö–ò ===== */
function renderCards(){
  els.cardsRoot.innerHTML='';
  for (const c of CARDS){
    const node=document.createElement('div'); node.className='kcard';
    const pic=document.createElement('div'); pic.className='pic';
    const img=document.createElement('img'); img.src=c.icon; img.alt=c.name; pic.appendChild(img);
    const body=document.createElement('div'); body.className='body';
    const title=document.createElement('div'); title.className='title'; title.textContent=c.name;
    const desc=document.createElement('div'); desc.className='desc'; desc.textContent=c.desc;
    const row=document.createElement('div'); row.className='row';
    const mini=document.createElement('div'); mini.className='mini'; mini.innerHTML=`+${c.tapBonus} –∑–∞ —Ç–∞–ø ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(c.cost)}`;
    const btn=document.createElement('button'); btn.className='buy'; btn.dataset.key=c.key;
    const bought=isCardBought(c.key); btn.textContent=bought?'–ö—É–ø–ª–µ–Ω–æ':'–ö—É–ø–∏—Ç—å'; btn.disabled=bought;
    row.appendChild(mini); row.appendChild(btn);
    body.appendChild(title); body.appendChild(desc); body.appendChild(row);
    node.appendChild(pic); node.appendChild(body);
    if (bought) node.classList.add('bought');
    els.cardsRoot.appendChild(node);
  }
  els.cardsRoot.querySelectorAll('.buy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key=btn.dataset.key, c=CARDS.find(x=>x.key===key); if (!c||isCardBought(key)) return;
      if (S.RabbitCoin>=c.cost){ S.RabbitCoin-=c.cost; setCardBought(key,true); haptic('medium'); updateUI(); save(); }
    });
  });
}

/* ===== Tabs ===== */
function setActiveTab(name){
  const isFood = name==='food';
  els.tabFood.classList.toggle('active',isFood);
  els.tabCards.classList.toggle('active',!isFood);
  els.viewFood.classList.toggle('active',isFood);
  els.viewCards.classList.toggle('active',!isFood);
  localStorage.setItem('rc_active_tab2', isFood?'food':'cards');
}
els.tabFood.addEventListener('click',()=>setActiveTab('food'));
els.tabCards.addEventListener('click',()=>setActiveTab('cards'));

/* ===== UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ===== */
function updateHeader(){
  els.balance.textContent = fmt(S.RabbitCoin);
  els.hps.textContent = totalHps();
  els.perTap.textContent = perTap();
  els.waterBuff.textContent = Math.floor((waterMult()-1)*100);
}
function updateFoodRows(){
  for (const sec of FOOD_SECTIONS) for (const it of sec.items){
    const sp=document.querySelector(`[data-lvl="${it.key}"]`); if (sp) sp.textContent=getLevel(it.key);
  }
  for (const sec of FOOD_SECTIONS) for (const it of sec.items){
    const cards=[...els.foodRoot.querySelectorAll('.card')];
    const card=cards.find(c=> (c.querySelector('.c-title')?.textContent||'').includes(it.name));
    if (!card) continue;
    const mini=card.querySelector('.mini'); if (mini) mini.innerHTML=renderFoodMini(it);
    const btn=card.querySelector('.buy'); if (btn){ const price=nextPrice(it,getLevel(it.key)); btn.disabled=S.RabbitCoin<price; }
  }
}
function updateCardsRows(){
  els.cardsRoot.querySelectorAll('.kcard').forEach((node,idx)=>{
    const c=CARDS[idx], btn=node.querySelector('.buy'), mini=node.querySelector('.mini');
    const bought=isCardBought(c.key);
    if (mini) mini.innerHTML=`+${c.tapBonus} –∑–∞ —Ç–∞–ø ‚Ä¢ —Ü–µ–Ω–∞: üü° ${fmt(c.cost)}`;
    if (btn){ btn.textContent=bought?'–ö—É–ø–ª–µ–Ω–æ':'–ö—É–ø–∏—Ç—å'; btn.disabled=bought || S.RabbitCoin<c.cost; }
    node.classList.toggle('bought', bought);
  });
}
function updateUI(){ updateHeader(); updateFoodRows(); updateCardsRows(); }

/* ===== –¢–∏–∫ ===== */
let acc=0, lastTs=performance.now();
function loop(ts){
  const dt=(ts-lastTs)/1000; lastTs=ts; acc+=dt;
  const step=0.1;
  while(acc>=step){ S.RabbitCoin += totalHps()*step; acc-=step; }
  if (Math.random()<0.02){ S.last=Date.now(); save(); }
  updateUI();
  requestAnimationFrame(loop);
}

/* ===== –°–æ–±—ã—Ç–∏—è ===== */
els.tapBtn.addEventListener('click', ()=>{
  const gain=perTap(); S.RabbitCoin+=gain; popText(els.tapBtn, `+${gain}`); haptic('light'); updateUI();
});

/* –í—Å–ø–ª—ã–≤–∞—à–∫–∞ */
function popText(anchorEl, text){
  const r=anchorEl.getBoundingClientRect();
  const b=document.createElement('div');
  b.textContent=text;
  b.style.position='fixed';
  b.style.left=(r.left+r.width/2)+'px';
  b.style.top=(r.top+r.height/2)+'px';
  b.style.transform='translate(-50%,-50%)';
  b.style.pointerEvents='none';
  b.style.color='#fff';
  b.style.textShadow = '0 2px 10px rgba(0,0,0,.6)'; /* —Ñ–∏–∫—Å */
  b.style.fontWeight='700';
  b.style.transition='all .6s ease';
  document.body.appendChild(b);
  requestAnimationFrame(()=>{ b.style.top=(r.top-30)+'px'; b.style.opacity='0'; b.style.scale='1.2'; });
  setTimeout(()=> b.remove(), 650);
}

/* ===== –°—Ç–∞—Ä—Ç ===== */
renderFood();
renderCards();
updateUI();
setActiveTab(localStorage.getItem('rc_active_tab2')==='cards'?'cards':'food');
requestAnimationFrame(loop);
</script>
</body>
</html>
